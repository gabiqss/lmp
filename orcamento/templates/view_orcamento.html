{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<div class="d-block mb-4 mb-md-0 py-4 "> 
    <h4>Orçamentos</h4> 
</div>   
{% if messages.success %}
              {% for message in messages %}
              <div class="alert alert-success alert-dismissible mt-2">
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> 
                  <span class="error-message">{{ message }}</span> 
              </div>
              {% endfor %}
            {% endif %}
<div class="row">
    <div class="col-12 col-sm-6 col-xl-3 mb-5">
      <div class="card border-0 shadow">
        <div class="card-body">
          <div class="row d-block d-xl-flex align-items-center">
            <div
              class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
              <div class="icon-shape icon-shape-info rounded me-4 me-sm-0">
                <i class="fas fa-file-alt fa-2x"></i>
              </div> 
            </div>
            <div class="col-12 col-xl-7 px-xl-0">
              <div class="d-none d-sm-block">
                <h6 class="  text-gray-400 mb-0">Orçamentos Abertos</h6> 
                <h3 class="fw-extrabold mb-2">{{opened_os_count}}</h3>
              </div> 
            </div>
          </div>
        </div>
      </div>
    </div> 
    <div class="col-12 col-sm-6 col-xl-3 mb-5">
        <div class="card border-0 shadow">
          <div class="card-body">
            <div class="row d-block d-xl-flex align-items-center">
              <div
                class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                <div class="icon-shape icon-shape-secondary rounded me-4 me-sm-0">
                  <i class="fas fa-clock fa-2x"></i>
                </div> 
              </div>
              <div class="col-12 col-xl-7 px-xl-0">
                <div class="d-none d-sm-block">
                  <h6 class=" text-gray-400 mb-0">Aguardando pagamento</h6>
                  <h3 class="fw-extrabold mb-2">{{await_payment_count}}</h3>
                </div> 
              </div>
            </div>
          </div>
        </div>
    </div> 
    <div class="col-12 col-sm-6 col-xl-3 mb-5">
        <div class="card border-0 shadow">
          <div class="card-body">
            <div class="row d-block d-xl-flex align-items-center">
              <div
                class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                <div class="icon-shape icon-shape-success rounded me-4 me-sm-0">
                  <i class="fas fa-check fa-2x"></i>
                </div> 
              </div>
              <div class="col-12 col-xl-7 px-xl-0">
                <div class="d-none d-sm-block">
                  <h6 class="text-gray-400 mb-0">Pagamento realizado</h6>
                  <h3 class="fw-extrabold mb-2">{{made_payment_count}}</h3>
                </div> 
              </div>
            </div>
          </div>
        </div>
    </div> 
    <div class="col-12 col-sm-6 col-xl-3 mb-5">
        <div class="card border-0 shadow">
          <div class="card-body">
            <div class="row d-block d-xl-flex align-items-center">
              <div
                class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                <div class="icon-shape icon-shape-danger rounded me-4 me-sm-0">
                  <i class="fas fa-times fa-2x"></i>
                </div> 
              </div>
              <div class="col-12 col-xl-7 px-xl-0">
                <div class="d-none d-sm-block">
                  <h6 class=" text-gray-400 mb-0" style="font-size:0.95rem">Orçamentos Cancelados</h6>
                  <h3 class="fw-extrabold mb-2">{{canceled_count}}</h3>
                </div> 
              </div>
            </div>
          </div>
        </div>
    </div> 
</div>
<div class="d-flex justify-content-between align-items-center flex-wrap mb-3"> 
  <div class="col-12 col-md-6 col-lg-4">
    <div class="input-group input-group-with-space">
        <input id="searchInput" name="search" type="text" class="form-control" placeholder="Pesquisar" aria-label="Pesquisar">
        <button id="searchButton" class="btn btn-primary" type="button"><i class="fas fa-search"></i></button>
    </div>
  </div>
  <div class="form-group d-flex justify-content-end ">  
    <a href="{% url 'orcamento_create' %}" class="btn btn-gray-800 my-3 ms-3">
      <i class="fas fa-plus px-1"></i> Orçamento
    </a> 
  </div>  
</div>
<div class="row">
  <div class="mb-5">
    <div class="card border-0 shadow components-section">
      <div class="card-body">
        <div class="accordion accordion-flush" id="accordionFlushExample"> 
          <div class="accordion-item">
            <h2 class="accordion-header" id="flush-headingOne">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                Orçamentos
              </button>
            </h2>
            <div id="flush-collapseOne" class="accordion-collapse collapse show" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
              <div class="accordion-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="border-gray-200">Cliente</th>
                                <th class="border-gray-200">Contato</th>
                                <th class="border-gray-200">Responsável</th>
                                <th class="border-gray-200">Validade da proposta</th>
                                <th class="border-gray-200">Condição de pagamento</th>
                                <th class="border-gray-200">Forma de Pagamento</th>
                                <th class="border-gray-200">Tipo de Orçamento</th>
                                <th class="border-gray-200">Data de Cadastro</th>
                                <th class="border-gray-200">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for orcamento in orcamentos %}      
                                <tr>
                                    <td>
                                      <div>
                                        <button class="btn btn-link text-dark dropdown-toggle dropdown-toggle-split m-0 p-0"
                                          data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                          <span class="fw-bolder text-gray-500">
                                            <span >{{ orcamento.solicitante }}</span>
                                          </span>
                                          <span class="visually-hidden">Toggle Dropdown</span>
                                        </button>
                                        <div class="dropdown-menu py-0 dropdown-menu-right">
                                          <a class="dropdown-item rounded-top" href="{% url 'pdf-orcamento' orcamento.id %}" ><span class="fas fa-file me-2"></span>Gerar PDF</a>
                                          <a class="dropdown-item rounded-top" href="{% url 'detail-orcamento' orcamento.id %}" ><span class="fas fa-eye me-2"></span>Ver detalhes</a>
                                          <a class="dropdown-item" href="{% url 'orcamento_update' orcamento.id %}"><span class="fas fa-edit me-2"></span>Editar</a>
                                          <a class="dropdown-item rounded-bottom" href="" data-bs-toggle="modal" data-bs-target="#logModal{{ orcamento.id }}"><span class="fas fa-history me-2"></span>Log de alterações</a>
                                          <a class="dropdown-item text-danger rounded-bottom" href="" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal{{ orcamento.id }}"><span class="fas fa-trash-alt me-2"></span>Deletar</a>
                                        </div>
                                    </td>
                                    <td>{{ orcamento.contato }}</td> 
                                    <td>{{ orcamento.responsavel }}</td> 
                                    <td>{{ orcamento.validade_proposta }}</td>
                                    <td>{{ orcamento.condicao_pagamento }}</td> 
                                    <td>{{ orcamento.forma_pagamento }}</td>
                                    <td>{{ orcamento.tipo_orcamento }}</td>
                                    <td> {{ orcamento.data_cadastro }} </td>
                                    <td>
                                      {% if orcamento.status == "Aberto" %}
                                        <p class="badge rounded-pill bg-success px-2 py-1">{{ orcamento.get_status_display }}</p>
                                      {% elif orcamento.status == "Aguardando pagamento" %}
                                        <p class="badge rounded-pill bg-warning px-2 py-1">{{ orcamento.get_status_display }}</p>
                                      {% elif orcamento.status == "Pagamento realizado" %}
                                        <p class="badge rounded-pill bg-primary px-2 py-1">{{ orcamento.get_status_display }}</p>
                                      {% elif orcamento.status == "Cancelado" %}
                                        <p class="badge rounded-pill bg-danger px-2 py-1">{{ orcamento.get_status_display }}</p>
                                      {% endif %}
                                    </td>  
                                </tr>   
                                <div class="modal fade" id="confirmDeleteModal{{ orcamento.id }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                  <div class="modal-dialog">
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Confirmação de Exclusão</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                      </div>
                                      <div class="modal-body">
                                        <p>Tem certeza que deseja deletar o orçamento {{ orcamento.id }}?</p>
                                      </div>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <a href="{% url 'delete-orcamento' orcamento.id %}" class="btn btn-danger">Deletar</a>
                                      </div>
                                    </div>
                                  </div>
                                </div>    
                                <div class="modal fade" id="logModal{{ orcamento.id }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                  <div class="modal-dialog">
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Log de alterações</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                      </div>
                                      <div class="modal-body">
                                      <a href="{% url 'pdf-orcamento' orcamento.id %}" target="_blank"><span class="fas fa-file me-2"></span> {{ orcamento }} - {{ orcamento.data_atualizacao }} </a><br>
                                      <hr>
                                      {% for alteracao in alteracoes %}
                                      {% if alteracao.orcamento == orcamento %}
                                          <a href="{% url 'pdf-orcamento' alteracao.id %}" target="_blank"><span class="fas fa-file me-2"></span> {{ alteracao }} - {{ alteracao.data_atualizacao }} (Alterado por: {{ alteracao.responsavel_atividade }}) </a><br>
                                          <hr>
                                      {% endif %}
                                      {% endfor %}
                                      
                                      </div>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                      </div>
                                    </div>
                                  </div>
                                </div>     
                            {% endfor %}
                        </tbody>
                    </table> 
                    <p id="noResultsMessage" class="text-center mt-4" style="display: none;">Nenhum resultado encontrado.</p>
                </div> 
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header" id="flush-headingTwo">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                Orçamentos Revisados
              </button>
            </h2>
            <div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="flush-headingTwo" data-bs-parent="#accordionFlushExample">
              <div class="accordion-body">
                <div class="table-responsive mb-5 ">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="border-gray-200">Cliente</th>
                                <th class="border-gray-200">Contato</th>
                                <th class="border-gray-200">Responsável</th>
                                <th class="border-gray-200">Validade da proposta</th>
                                <th class="border-gray-200">Condição de pagamento</th>
                                <th class="border-gray-200">Forma de Pagamento</th>
                                <th class="border-gray-200">Tipo de Orçamento</th>
                                <th class="border-gray-200">Data de Cadastro</th>
                                <th class="border-gray-200">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for revisao in revisoes %}      
                                <tr>
                                    <td>
                                      <div>
                                        <button class="btn btn-link text-dark dropdown-toggle dropdown-toggle-split m-0 p-0"
                                          data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                          <span class="fw-bolder text-gray-500">
                                            <span >{{ revisao.solicitante }}</span>
                                          </span>
                                          <span class="visually-hidden">Toggle Dropdown</span>
                                        </button>
                                        <div class="dropdown-menu py-0 dropdown-menu-right">
                                          <a class="dropdown-item rounded-top" href="{% url 'pdf-orcamento' revisao.id %}" ><span class="fas fa-file me-2"></span>Gerar PDF</a>
                                          <a class="dropdown-item rounded-top" href="{% url 'detail-orcamento' revisao.id %}" ><span class="fas fa-eye me-2"></span>Ver detalhes</a>
                                          <a class="dropdown-item" href="{% url 'orcamento_update' revisao.id %}"><span class="fas fa-edit me-2"></span>Editar</a>
                                          <a class="dropdown-item rounded-bottom" href="" data-bs-toggle="modal" data-bs-target="#logModal{{ revisao.id }}"><span class="fas fa-history me-2"></span>Log de alterações</a>
                                          <a class="dropdown-item text-danger rounded-bottom" href="" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal{{ revisao.id }}"><span class="fas fa-trash-alt me-2"></span>Deletar</a>
                                        </div>
                                      </td>
                                    <td>{{ revisao.contato }}</td>
                                    <td>{{ revisao.responsavel }}</td>
                                    <td>{{ revisao.validade_proposta }}</td>
                                    <td>{{ revisao.condicao_pagamento }}</td>
                                    <td>{{ revisao.forma_pagamento }}</td>
                                    <td>{{ revisao.tipo_orcamento }}</td>
                                    <td> {{ revisao.data_cadastro }} </td>
                                    <td>
                                      {% if revisao.status == "Aberto" %}
                                        <p class="badge rounded-pill bg-success px-2 py-1">{{ revisao.get_status_display }}</p>
                                      {% elif revisao.status == "Aguardando pagamento" %}
                                        <p class="badge rounded-pill bg-warning px-2 py-1">{{ revisao.get_status_display }}</p>
                                      {% elif revisao.status == "Pagamento realizado" %}
                                        <p class="badge rounded-pill bg-primary px-2 py-1">{{ revisao.get_status_display }}</p>
                                      {% elif revisao.status == "Cancelado" %}
                                        <p class="badge rounded-pill bg-danger px-2 py-1">{{ revisao.get_status_display }}</p>
                                      {% endif %}
                                    </td>  
                                </tr>   
                                <div class="modal fade" id="confirmDeleteModal{{ orcamento.id }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                  <div class="modal-dialog">
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Confirmação de Exclusão</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                      </div>
                                      <div class="modal-body">
                                        <p>Tem certeza que deseja deletar o orçamento {{ orcamento.id }}?</p>
                                      </div>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <a href="{% url 'delete-orcamento' revisao.id %}" class="btn btn-danger">Deletar</a>
                                      </div>
                                    </div>
                                  </div>
                                </div>      
                            {% endfor %}
                        </tbody>
                    </table> 
                    <p id="noResultsMessage" class="text-center mt-4" style="display: none;">Nenhum resultado encontrado.</p>
                </div> 
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function gerarPDF(orcamentoId) {
      const url = "{% url 'pdf-orcamento' 0 %}".replace("0", orcamentoId);
  
      // Tente buscar o URL antes de redirecionar
      fetch(url, { method: 'HEAD' })
          .then(response => {
              if (response.ok) {
                  // Se o URL estiver disponível, redirecione
                  window.location.href = url;from django.contrib.auth.decorators import login_required
              } else {
                  // Se houver algum problema, exiba um alerta
                  alert('Erro ao gerar o PDF: URL não disponível.');
              }
          })
          .catch(error => {
              // Se ocorrer um erro, exiba um alerta
              alert('Erro ao gerar o PDF: ' + error.message);
          });
  }
  </script>
  
{% endblock content %}